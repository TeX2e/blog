---
layout:        post
title:         "ディレクトリのパスの最後に/を付けてはいけない"
menutitle:     "ディレクトリのパスの最後に/を付けてはいけない"
date:          2016-04-22
tags:          Shell
category:      Shell
author:        tex2e
cover:         /assets/mountain-alternative-cover.jpg
redirect_from:
comments:      false
published:     true
---

ShellScriptで、ディレクトリのパスの最後に/を付けてたときに発生する可能性のある問題について

ケース1
--------

ディレクトリのパスを引数に取り、
そのディレクトリの下に bin というディレクトリを作成する関数 create_bin というのがあるとする。

```bash
function create_bin {
    local dir=$1
    mkdir "$dir/bin"
}
```

一見するとこのコードは正しく動く。
しかし引数に渡されたディレクトリのパスの最後に/が付いていたらどうだろうか。

```bash
$ create_bin hoge/
mkdir: hoge: No such file or directory
```

これはかなり奇妙だ。ディレクトリを作ろうとしているのに「そんなディレクトリはない」と怒られた。
しかし、少し考えてみれば create_bin の中の `"$dir/bin"` は `hoge//bin` と展開され、
スラッシュが2つ連続するから、そんなディレクトリは作れないのである。

そこで、この「期待していないスラッシュ」を取り除くために、
この関数を次のようにほんの少し手直しする必要がある。

```bash
function create_bin {
    local dir=${1%/}
    mkdir "$dir/bin"
}
```

この `${変数名%パターン}` は **パターンマッチ演算子** と呼ばれ、
この場合は、変数の値の末尾から見て / にマッチした場合はそれを削除し、残りの部分を返す。
もちろんこれで問題は解決なのだが、
ディレクトリのパスを引数に取る全ての関数でこれと同じことをしないといけないのは、
かなり面倒である。

そこで、ユーザの入力などの信頼されていない値（トップレベルでの`$1`や`$2`など）には
例のパターンマッチ演算子を適用させ、
スクリプト内からしか利用されないプライベートな関数には、
ディレクトリのパスの最後のスラッシュを取り除いた安全な値を渡してあげるようにするのが、
ベストプラクティスだと思われる。

#### 結論

自分のスクリプト内では、ディレクトリのパスの最後に/がない状態の変数を使うこと。


ケース2
----------

残念なことに、前のプログラマが書いた（複雑で読めない）シェルスクリプトには、
ケース1のようなバグを含む関数が大量にあって、ディレクトリのパスには
「期待されないスラッシュ」が挿入されたまま保存されている。

```bash
$ echo $SAMPLE_PATH
hoge/fuga//piyo///bin
```

目標は、重複したスラッシュを1つにまとめることである。
重複を取り除く、というと uniq などが思いつくが uniq は行に対して重複を取り除くのである。
文字に対しては tr -s を使う。

```bash
$ echo $SAMPLE_PATH | tr -s /
hoge/fuga/piyo/bin
```

というわけで、tr -s を使えば問題は解決するが、
シェルスクリプトを書くプログラマは最初からディレクトリのパスの最後に/がない状態の変数を使うようにしていれば、
こんな問題は発生しないのである。

#### 結論（2回目）

自分のスクリプト内では、ディレクトリのパスの最後に/がない状態の変数を使うこと。


ケース3
---------

次は割と危険なスクリプトである。

```bash
DIR_PATH="path/to/dir"

rm -rf "$DIR_PAHT/"
```

一見するとこのコードは正しく動く。
しかし、注意して変数名を見ると、`DIR_PAHT` は入力ミスで正しくは `DIR_PATH` である。
入力ミスでプログラムが動かないのはよくあるとしても、今回の場合は動いてしまう。
なぜなら、代入されていない変数は空文字列を返すため `rm -rf "$DIR_PAHT/"` は `rm -rf "/"`
となる。
Oops! これは破壊の呪文「バルス」にかなり近い形だ。
POSIXに準拠した rm コマンドならエラーを吐くだけで、何もしないはずだがそんなの怖くて試すことはできない。

ところで、ディレクトリのパスの最後のスラッシュがなければ、こんな問題は発生しなかったはずである。

```bash
DIR_PATH="path/to/dir"

rm -rf "$DIR_PAHT"
```

#### 結論（3回目）

くどいようだが、自分のスクリプト内では、ディレクトリのパスの最後に/がない状態の変数（文字列）を使うこと。

以上。
